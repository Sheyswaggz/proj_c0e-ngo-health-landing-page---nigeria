# Kubernetes Deployment manifest for NGO Landing Page
# Production-ready configuration with security best practices, health checks, and resource management
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngo-landing-page-deployment
  labels:
    app: ngo-landing-page
    version: v1.0.0
    component: frontend
    tier: web
  annotations:
    description: "Static landing page deployment for NGO Health - Nigeria"
    deployment.kubernetes.io/revision: "1"
spec:
  # Replica configuration - 3 replicas for high availability
  replicas: 3
  revisionHistoryLimit: 10
  
  # Rolling update strategy for zero-downtime deployments
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Allow 1 extra pod during updates
      maxUnavailable: 0  # Maintain all pods during updates for zero downtime
  
  # Pod selector - must match template labels
  selector:
    matchLabels:
      app: ngo-landing-page
  
  # Pod template specification
  template:
    metadata:
      labels:
        app: ngo-landing-page
        version: v1.0.0
        component: frontend
        tier: web
      annotations:
        # Prometheus metrics scraping configuration
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    
    spec:
      # Security context for all containers in the pod
      securityContext:
        runAsNonRoot: true    # Enforce non-root user execution
        runAsUser: 1000       # Run as user ID 1000 (nginx user)
        runAsGroup: 1000      # Run as group ID 1000
        fsGroup: 1000         # Set filesystem group ownership
        seccompProfile:
          type: RuntimeDefault  # Use default seccomp profile for security
      
      # Termination grace period for graceful shutdown
      terminationGracePeriodSeconds: 30
      
      # Main application container
      containers:
        - name: ngo-landing-page
          # Container image - placeholder, should be replaced with actual registry
          image: ghcr.io/org/ngo-landing-page:latest
          imagePullPolicy: IfNotPresent
          
          # Container security context
          securityContext:
            allowPrivilegeEscalation: false  # Prevent privilege escalation
            readOnlyRootFilesystem: true     # Read-only root filesystem for security
            runAsNonRoot: true               # Enforce non-root user
            runAsUser: 1000                  # Run as nginx user
            capabilities:
              drop:
                - ALL                        # Drop all capabilities
              add:
                - NET_BIND_SERVICE          # Allow binding to privileged ports
          
          # Container port configuration
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          
          # Resource requests and limits
          resources:
            requests:
              memory: "64Mi"   # Minimum memory required
              cpu: "50m"       # Minimum CPU required (0.05 cores)
            limits:
              memory: "128Mi"  # Maximum memory allowed
              cpu: "200m"      # Maximum CPU allowed (0.2 cores)
          
          # Liveness probe - checks if container is alive
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
              httpHeaders:
                - name: X-Probe-Type
                  value: liveness
            initialDelaySeconds: 30  # Wait 30s before first probe
            periodSeconds: 10        # Check every 10 seconds
            timeoutSeconds: 5        # Timeout after 5 seconds
            failureThreshold: 3      # Restart after 3 consecutive failures
            successThreshold: 1      # Consider healthy after 1 success
          
          # Readiness probe - checks if container is ready to serve traffic
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
              httpHeaders:
                - name: X-Probe-Type
                  value: readiness
            initialDelaySeconds: 5   # Wait 5s before first probe
            periodSeconds: 5         # Check every 5 seconds
            timeoutSeconds: 3        # Timeout after 3 seconds
            failureThreshold: 3      # Mark unready after 3 consecutive failures
            successThreshold: 1      # Mark ready after 1 success
          
          # Environment variables from ConfigMap
          envFrom:
            - configMapRef:
                name: ngo-landing-page-config
          
          # Volume mounts for writable directories
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /var/cache/nginx
            - name: run
              mountPath: /var/run
          
          # Lifecycle hooks for graceful shutdown
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - sleep 15  # Grace period for connection draining before shutdown
      
      # Volumes for writable directories (required for read-only root filesystem)
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 100Mi
        - name: cache
          emptyDir:
            sizeLimit: 100Mi
        - name: run
          emptyDir:
            sizeLimit: 10Mi